{% extends 'base.html' %}
{% load static %}

{% block page_title %}Venue Management{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f4f6f9; }
    .admin-card { background: #fff; border-radius: 12px; border: 1px solid #dee2e6; box-shadow: 0 0 10px rgba(0,0,0,.05); }
    .btn-admin-primary { background: linear-gradient(135deg, #0d6efd, #084298); color: #fff; border: none; border-radius: 8px; }
    .icon-btn { width: 34px; height: 34px; padding: 0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
    .node-item { background: #fff; border: 1px solid #e3e6ef; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
    .child-container { margin-left: 28px; padding-left: 18px; border-left: 2px dashed #0d6efd; min-height: 10px; }
</style>

<div class="container-fluid py-4">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-semibold text-primary">
            <i class="bi bi-buildings me-2"></i>Venue Management
        </h3>
        <button class="btn btn-admin-primary px-4 py-2" data-bs-toggle="modal" data-bs-target="#addVenueModal">
            <i class="bi bi-plus-circle me-1"></i> Add Venue
        </button>
    </div>

    <div class="admin-card p-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-primary">
                    <tr>
                        <th>#</th>
                        <th>Venue Name</th>
                        <th>Type</th>
                        <th>Capacity</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for venue in venues %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td class="fw-semibold">{{ venue.name }}</td>
                        <td><span class="badge bg-info text-dark">{{ venue.venue_type|default:"N/A" }}</span></td>
                        <td><span class="badge bg-success">{{ venue.total_capacity|default:"0" }}</span></td>
                        <td class="text-center">
                            <button class="btn btn-outline-primary icon-btn" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#viewHierarchyModal" 
                                    onclick="loadHierarchy({{ venue.id }})">
                                <i class="fas fa-sitemap"></i>
                            </button>


                            <form method="POST" action="{% url 'delete_venue' venue.id %}" class="d-inline">
                                {% csrf_token %}
                                <button class="btn btn-outline-danger icon-btn" onclick="return confirm('Are you sure you want to delete this venue?')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-5">No venues found. Click "Add Venue" to start.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addVenueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" onsubmit="return prepareJsonData('tree-new')">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Create New Venue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Venue Name</label>
                            {{ venue_form.name }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Venue Type</label>
                            {{ venue_form.venue_type }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Total Capacity</label>
                            {{ venue_form.total_capacity }}
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Location</label>
                            {{ venue_form.location }}
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0"><i class="bi bi-diagram-3 me-2"></i>Seating Hierarchy</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewNode('tree-new')">
                            <i class="bi bi-plus-lg"></i> Add Root Level
                        </button>
                    </div>

                    <div id="tree-new" class="border rounded p-3 bg-light" style="min-height: 100px;"></div>
                    
                    <input type="hidden" name="hierarchy_json" id="json-input-new">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" name="add_venue" class="btn btn-primary px-4">Save Venue</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="viewHierarchyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <form id="edit-hierarchy-form" method="POST">
                {% csrf_token %}
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Manage Venue Layout</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addNewNode('hierarchy-container')">
                        <i class="bi bi-plus"></i> Add Root Category
                    </button>

                    <div id="hierarchy-container" class="border rounded p-3 bg-light" style="min-height: 100px;"></div>
                    <input type="hidden" name="hierarchy_json" id="json-input-existing">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Layout</button>
                </div>
            </form>
        </div>
    </div>
</div>

<template id="node-template">
    <div class="node-item">
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <input class="form-control node-name" placeholder="Name (e.g. North Stand)">
            </div>
            <div class="col-md-3">
                <input class="form-control node-type" placeholder="Type (e.g. Stand/Block)">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control node-seats" placeholder="Seats">
            </div>
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-sm btn-outline-primary icon-btn me-1" onclick="addNewNode(this)" title="Add Child">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger icon-btn" onclick="this.closest('.node-item').remove()" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="child-container mt-2"></div>
    </div>
</template>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Helper to add a new node to the tree
function addNewNode(trigger) {
    let container = typeof trigger === 'string'
        ? document.getElementById(trigger)
        : trigger.closest('.node-item').querySelector('.child-container');

    const template = document.getElementById('node-template').content.cloneNode(true);
    container.appendChild(template);
}

// Recursively builds the JSON structure from the UI
function buildTree(container) {
    let data = [];
    container.querySelectorAll(':scope > .node-item').forEach(item => {
        const name = item.querySelector('.node-name').value.trim();
        if (name) {
            data.push({
                name: name,
                type: item.querySelector('.node-type').value,
                seats: parseInt(item.querySelector('.node-seats').value) || 0,
                children: buildTree(item.querySelector('.child-container'))
            });
        }
    });
    return data;
}

// Maps tree data to the hidden input fields before form submission
function prepareJsonData(containerId) {
    const container = document.getElementById(containerId);
    const tree = buildTree(container);
    
    const inputId = (containerId === 'tree-new') ? 'json-input-new' : 'json-input-existing';
    document.getElementById(inputId).value = JSON.stringify(tree);
    return true;
}

// Fetches existing hierarchy and renders it in the modal
function loadHierarchy(id) {
    const form = document.getElementById('edit-hierarchy-form');
    const container = document.getElementById('hierarchy-container');
    form.action = `/venues/save-hierarchy/${id}/`;
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p>Loading Layout...</p></div>';

    fetch(`/venues/${id}/hierarchy/`)
        .then(res => res.json())
        .then(data => {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No layout defined for this venue.</p>';
            } else {
                renderHierarchy(container, data);
            }
        })
        .catch(err => {
            container.innerHTML = '<p class="text-danger">Error loading layout.</p>';
        });
}

// Recursively renders nodes from JSON data
function renderHierarchy(container, data) {
    data.forEach(item => {
        const template = document.getElementById('node-template').content.cloneNode(true);
        const node = template.querySelector('.node-item');
        
        node.querySelector('.node-name').value = item.name;
        node.querySelector('.node-type').value = item.type;
        node.querySelector('.node-seats').value = item.seats;
        
        container.appendChild(node);
        if (item.children && item.children.length > 0) {
            renderHierarchy(node.querySelector('.child-container'), item.children);
        }
    });
}

// Attach submission logic to the existing hierarchy form
document.getElementById('edit-hierarchy-form').onsubmit = function() {
    return prepareJsonData('hierarchy-container');
};
</script>
{% endblock %}